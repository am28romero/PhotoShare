@page "/folder/{FolderId:int}"
@using PhotoShare.Services
@inject MediaService MediaService
@inject FolderService FolderService
@inject NavigationManager Nav

<h3>Viewing Folder</h3>

@if (folder is null)
{
    <p>Folder not found or access denied.</p>
}
else
{
    <h4>@folder.Name</h4>
    <InputFile OnChange="HandleUpload" />
    <ul>
        @foreach (var file in media)
        {
            <li>
                @file.FileName
                <button @onclick="() => DeleteFile(file.Id)">🗑️</button>
            </li>
        }
    </ul>
}

@code {
    [Parameter] public int FolderId { get; set; }

    Folder? folder;
    List<MediaItem> media = [];

    protected override async Task OnInitializedAsync()
    {
        folder = await FolderService.GetFolderAsync(FolderId);
        if (folder != null)
        {
            media = await MediaService.ListMediaAsync(folder.Id);
        }
    }

    async Task HandleUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        using var stream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
        var formFile = new FormFile(stream, 0, file.Size, file.Name, file.Name)
        {
            Headers = new HeaderDictionary(),
            ContentType = file.ContentType
        };

        await MediaService.UploadFileAsync(formFile, FolderId);
        media = await MediaService.ListMediaAsync(FolderId);
    }

    async Task DeleteFile(int id)
    {
        await MediaService.DeleteMediaAsync(id);
        media = await MediaService.ListMediaAsync(FolderId);
    }
}